<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreteFleet SaaS - Gestão Logística</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet" />
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">

    <link rel="icon" type="image/x-icon" href="img/app.ico">
</head>

<body>

    <div id="authScreen"
        class="d-flex align-items-center justify-content-center vh-100 bg-light position-fixed top-0 start-0 w-100"
        style="z-index: 9999;">

        <div id="authLoading" class="text-center animate-enter">
            <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status"></div>
            <h5 class="mt-3 text-muted fw-bold">Iniciando Sistema...</h5>
        </div>

        <div id="authForms" class="glass-card animate-enter p-4 shadow-lg rounded-4 d-none"
            style="max-width: 400px; width: 90%; background: rgba(255,255,255,0.9);">
            <div class="text-center mb-4">
                <i class="fas fa-truck-fast fa-3x text-primary mb-2"></i>
                <h2 class="fw-bold text-dark">FreteFleet</h2>
                <p class="text-muted small">Plataforma Inteligente de Roteirização</p>
            </div>

            <ul class="nav nav-tabs nav-fill mb-3" id="authTab" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab"
                        data-bs-target="#loginPane">Entrar</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#registerPane">Criar
                        Conta</button></li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="loginPane">
                    <form id="formLogin">
                        <input type="email" id="loginEmail" class="form-control mb-2" placeholder="Seu Email" required>
                        <input type="password" id="loginPass" class="form-control mb-3" placeholder="Sua Senha"
                            required>
                        <button type="button" id="btnLogin" class="btn btn-primary w-100 mb-3 fw-bold">ACESSAR</button>
                        <div class="text-center mb-2"><span class="text-muted small">- ou -</span></div>
                        <button type="button" id="btnLoginGoogle" class="btn btn-outline-dark w-100">
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18"
                                class="me-2"> Entrar com Google
                        </button>
                    </form>
                </div>
                <div class="tab-pane fade" id="registerPane">
                    <form id="formRegister">
                        <input type="text" id="regName" class="form-control mb-2" placeholder="Nome Completo" required>
                        <input type="text" id="regCompany" class="form-control mb-2" placeholder="Nome da Empresa"
                            required>
                        <input type="text" id="regRole" class="form-control mb-2" placeholder="Cargo (Ex: Gestor)"
                            required>
                        <input type="email" id="regEmail" class="form-control mb-2" placeholder="Email" required>
                        <input type="password" id="regPass" class="form-control mb-3"
                            placeholder="Senha (Min 6 dígitos)" required>
                        <button type="button" id="btnRegister" class="btn btn-success w-100 fw-bold">CRIAR
                            CONTA</button>
                    </form>
                </div>
            </div>
            <div id="authError" class="alert alert-danger mt-3 d-none small text-center p-2 mb-0"></div>
        </div>
    </div>

    <div class="main-layout opacity-0">

        <div class="sidebar-container d-flex flex-column" id="sidebar">

            <div class="p-3 border-bottom d-flex align-items-center justify-content-between bg-white">
                <div class="d-flex align-items-center gap-2">
                    <div class="bg-primary text-white rounded p-1"><i class="fas fa-truck"></i></div>
                    <span class="fw-bold h6 mb-0">FreteFleet</span>
                </div>
                <button class="btn btn-sm btn-light text-muted" id="btnOpenAbout" title="Sobre o Sistema">
                    <i class="fas fa-info-circle"></i>
                </button>
            </div>

            <div class="px-2 pt-2">
                <ul class="nav nav-pills nav-fill gap-1 small" id="mainTab" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#config-pane">
                            <i class="fas fa-sliders-h me-1"></i>Config
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#locations-pane">
                            <i class="fas fa-map-marker-alt me-1"></i>Locais
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#routes-pane">
                            <i class="fas fa-map-marked-alt me-1"></i>Rotas
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#data-pane">
                            <i class="fas fa-table me-1"></i>Dados
                        </button>
                    </li>
                </ul>
            </div>

            <div class="tab-content flex-grow-1 position-relative">

                <div class="tab-pane fade show active p-0" id="config-pane">
                    <div class="scroll-area p-3">

                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-body p-3">
                                <h6 class="fw-bold small text-primary mb-3"><i class="fas fa-cog me-1"></i> Parâmetros
                                    Globais</h6>

                                <div class="row g-2 mb-2 align-items-end">
                                    <div class="col-7">
                                        <label class="form-label x-small text-muted">Origem (Ind/CD)</label>
                                        <div class="input-group input-group-sm">
                                            <button class="btn btn-outline-secondary" type="button"
                                                id="btnSelectOrigin"><i class="fas fa-list"></i>
                                            </button>
                                            <input type="text" class="form-control" id="origemInput"
                                                placeholder="Digite aqui ou selecione..." readonly>
                                        </div>
                                    </div>
                                    <div class="col-5">
                                        <div class="form-check form-switch mb-1">
                                            <input class="form-check-input" type="checkbox" id="returnToOrigin">
                                            <label class="form-check-label x-small" for="returnToOrigin">Considerar
                                                Retorno</label>
                                        </div>
                                    </div>
                                </div>

                                <div class="row g-2">
                                    <div class="col-4">
                                        <label class="form-label x-small text-muted">Raio Pedidos (km)</label>
                                        <input type="number" class="form-control form-control-sm" id="radiusInput"
                                            value="200">
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label x-small text-muted">Custo do Diesel (R$)</label>
                                        <input type="number" class="form-control form-control-sm" id="dieselPrice"
                                            value="6.00">
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label x-small text-muted">Tempo Descarga (min)</label>
                                        <input type="number" class="form-control form-control-sm" id="unloadTime"
                                            value="45">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label fw-bold small text-primary mb-0">
                                        <i class="fas fa-file-excel me-1"></i> Importar Pedidos
                                    </label>
                                    <a href="Modelo Planilha.xlsx" download
                                        class="badge bg-success text-white text-decoration-none"
                                        title="Baixar Planilha Modelo">
                                        <i class="fas fa-download me-1"></i> Baixar Modelo
                                    </a>
                                </div>

                                <div class="input-group input-group-sm">
                                    <input type="file" class="form-control" id="excelInput" accept=".xlsx, .xls">
                                </div>
                                <div class="form-text x-small mt-1"><i class="fas fa-info-circle"></i> Colunas: Pedido,
                                    Cliente, Endereço...</div>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-header bg-white py-2 border-bottom-0" data-bs-toggle="collapse"
                                data-bs-target="#fleetCollapse" style="cursor: pointer;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="fw-bold small text-primary mb-0"><i class="fas fa-truck me-1"></i> Frota
                                        Disponível</h6>
                                    <i class="fas fa-chevron-down text-muted x-small"></i>
                                </div>
                            </div>
                            <div class="collapse" id="fleetCollapse">
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped mb-0 text-center small align-middle"
                                        style="font-size: 0.75rem;">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width: 20px;">#</th>
                                                <th class="text-start">Tipo</th>
                                                <th>Cap(kg)</th>
                                                <th>Qtd</th>
                                                <th>Stops</th>
                                                <th>Fixo R$</th>
                                                <th>Km/L</th>
                                                <th>Eixos</th>
                                            </tr>
                                        </thead>
                                        <tbody id="fleetTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex mt-4">
                            <button class="btn btn-outline-secondary btn-sm flex-fill" id="btnResetConfig"><i
                                    class="fas fa-undo me-1"></i> Resetar</button>
                            <button class="btn btn-secondary btn-sm flex-fill" id="btnSaveConfig"><i
                                    class="fas fa-save me-1"></i> Salvar</button>
                            <button class="btn btn-primary btn-sm flex-grow-1 fw-bold" id="btnCalcular"><i
                                    class="fas fa-calculator me-1"></i> OTIMIZAR ROTAS</button>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade p-0 h-100" id="locations-pane">
                    <div class="scroll-area p-3">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-white">
                                <h6 class="fw-bold small text-primary mb-0"><i class="fas fa-map-marker-alt me-1"></i>
                                    Locais Salvos</h6>
                            </div>
                            <div class="card-body p-0 d-flex flex-column">
                                <div class="p-3 bg-light border-bottom">
                                    <label class="small text-muted mb-1">Adicionar Novo Local</label>
                                    <div class="input-group input-group-sm mb-2">
                                        <input type="text" class="form-control" id="newLocName"
                                            placeholder="Nome (ex: CD Matriz)">
                                    </div>
                                    <div class="input-group input-group-sm">
                                        <input type="text" class="form-control" id="newLocLink"
                                            placeholder="Link Google Maps ou Endereço">
                                        <button class="btn btn-success fw-bold" id="btnAddLoc"><i
                                                class="fas fa-plus me-1"></i> Adicionar</button>
                                    </div>
                                </div>
                                <div class="flex-grow-1 overflow-auto p-2">
                                    <div id="savedLocationsList"
                                        class="list-group list-group-flush border rounded bg-white">
                                        <div class="text-center p-3 text-muted small">Nenhum local salvo.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade p-0 h-100" id="routes-pane">
                    <ul class="nav nav-tabs nav-justified bg-white border-bottom small" role="tablist">
                        <li class="nav-item"><button class="nav-link active py-2 rounded-0 border-top-0"
                                data-bs-toggle="tab" data-bs-target="#results-tab"><i
                                    class="fas fa-route text-success"></i> Rotas Geradas</button></li>
                        <li class="nav-item"><button class="nav-link py-2 rounded-0 border-top-0" data-bs-toggle="tab"
                                data-bs-target="#backlog-tab"><i class="fas fa-exclamation-circle text-warning"></i>
                                Pendentes <span class="badge bg-danger rounded-pill" id="backlogBadge">0</span></button>
                        </li>
                    </ul>

                    <div class="tab-content flex-grow-1 overflow-hidden bg-light">
                        <div class="tab-pane fade show active h-100" id="results-tab">
                            <div class="scroll-area p-2" id="resultsContainer">
                                <div class="text-center mt-5 text-muted small">
                                    <i class="fas fa-map-signs fa-3x mb-3 opacity-25"></i>
                                    <p>Configure e clique em Otimizar.</p>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade h-100" id="backlog-tab">
                            <div class="scroll-area p-2" id="backlogContainer">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade p-0" id="data-pane">
                    <div class="h-100 bg-white p-3 overflow-auto">
                        <table class="table table-hover table-striped table-bordered small w-100" id="dataTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Pedido</th>
                                    <th>Supervisor</th>
                                    <th>Cliente</th>
                                    <th>Bairro</th>
                                    <th>Cidade</th>
                                    <th>Peso</th>
                                    <th>Agendado</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

            </div>

            <div class="p-3 border-top bg-white d-flex align-items-center justify-content-between"
                style="min-height: 60px;">
                <div id="userInfoDisplay" class="d-flex align-items-center gap-2 overflow-hidden"
                    style="max-width: 75%; cursor:pointer;">
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                </div>

                <button id="btnConfirmLogout" class="btn btn-outline-danger btn-sm border-0" title="Sair do Sistema">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <div class="dragbar" id="dragbar"></div>

        <div class="map-container">
            <div id="map"></div>

            <div class="position-absolute top-0 start-0 m-3 bg-white rounded shadow-sm p-1 d-flex gap-2"
                style="z-index: 1000; width: 300px;">
                <input type="text" class="form-control form-control-sm border-0" placeholder="Buscar no mapa...">
                <button class="btn btn-sm btn-primary"><i class="fas fa-search"></i></button>
            </div>
        </div>

    </div>

    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="liveToast" class="toast align-items-center text-white bg-primary border-0" role="alert"
            aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body fw-bold" id="toastMessage">...</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <div class="modal-backdrop fade show d-none" id="loadingBackdrop"></div>
    <div class="modal fade" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered text-center">
            <div class="modal-content bg-transparent border-0 shadow-none">
                <div class="spinner-border text-light mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
                <h5 class="text-white fw-bold" id="loadingModalText">Carregando...</h5>
            </div>
        </div>
    </div>

    <div class="modal fade" id="genericModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-4" id="genericModalBody"></div>
                <div class="modal-footer justify-content-center border-0 pt-0">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-4">
                    <div id="confirmModalBody" class="mb-3 fw-bold"></div>
                    <div class="d-flex gap-2 justify-content-center">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="btnConfirmAction">Confirmar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="statusModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header py-2">
                    <h6 class="modal-title fw-bold">Filtrar Status</h6>
                </div>
                <div class="modal-body p-2" id="statusFilterList" style="max-height: 300px; overflow-y: auto;"></div>
                <div class="modal-footer py-1">
                    <button type="button" class="btn btn-secondary btn-sm" id="btnCancelStatus">Todos</button>
                    <button type="button" class="btn btn-primary btn-sm" id="btnConfirmStatus">Filtrar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="originModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header py-2">
                    <h6 class="modal-title">Selecionar Origem</h6>
                </div>
                <div class="list-group list-group-flush" id="modalOriginList"></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="profileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold"><i class="fas fa-user-circle"></i> Meu Perfil</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label small text-muted">Nome</label>
                        <input type="text" class="form-control" id="profName" disabled>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label small text-muted">Email</label>
                            <input type="email" class="form-control" id="profEmail" disabled>
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted">Telefone</label>
                            <input type="tel" class="form-control" id="profPhone">
                        </div>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label small text-muted">Cargo</label>
                            <input type="text" class="form-control" id="profJobTitle">
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted">Acesso</label>
                            <input type="text" class="form-control bg-light" id="profAccessLevel" disabled>
                        </div>
                    </div>

                    <hr>

                    <h6 class="fw-bold text-primary mb-2"><i class="fas fa-building"></i> Empresa e Filial</h6>
                    <div class="mb-3">
                        <label class="form-label small text-muted">Empresa</label>
                        <input type="text" class="form-control" id="profCompany">
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-muted">Filial Principal</label>
                        <select class="form-select" id="profBranch">
                            <option value="">Carregando...</option>
                        </select>
                    </div>

                    <div id="teamManagementSection" class="d-none">
                        <hr>
                        <h6 class="fw-bold text-success mb-2"><i class="fas fa-users"></i> Gestão de Equipe</h6>

                        <div class="input-group input-group-sm mb-2">
                            <input type="text" class="form-control" id="newMemberName" placeholder="Nome">
                            <input type="email" class="form-control" id="newMemberEmail" placeholder="Email">
                        </div>
                        <div class="input-group input-group-sm mb-3">
                            <input type="text" class="form-control" id="newMemberJobTitle"
                                placeholder="Cargo (Ex: Analista)">
                            <select class="form-select" id="newMemberRole" style="max-width: 100px;">
                                <option value="Operacional">Oper.</option>
                                <option value="Admin">Admin</option>
                            </select>
                            <button class="btn btn-success" id="btnAddMember"><i class="fas fa-user-plus"></i></button>
                        </div>

                        <div class="list-group list-group-flush border rounded bg-light" id="teamMembersList"
                            style="max-height: 150px; overflow-y: auto;">
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light justify-content-between">
                    <button type="button" class="btn btn-outline-danger btn-sm border-0" id="btnDeleteAccount">
                        <i class="fas fa-trash-alt me-1"></i> Excluir Conta
                    </button>
                    <button type="button" class="btn btn-primary px-4" id="btnSaveProfile">Salvar Alterações</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editMemberModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header py-2">
                    <h6 class="modal-title">Editar Membro</h6>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editMemberEmail">
                    <div class="mb-2">
                        <label class="small text-muted">Nome</label>
                        <input type="text" class="form-control form-control-sm" id="editMemberNameDisplay" disabled>
                    </div>
                    <div class="mb-2">
                        <label class="small text-muted">Cargo</label>
                        <input type="text" class="form-control form-control-sm" id="editMemberJobTitle">
                    </div>
                    <div class="mb-2">
                        <label class="small text-muted">Permissão</label>
                        <select class="form-select form-select-sm" id="editMemberRole">
                            <option value="Operacional">Operacional</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer py-1">
                    <button type="button" class="btn btn-primary btn-sm w-100" id="btnConfirmEditMember">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

    <script type="module" src="js/firebaseConfig.js"></script>
    <script type="module" src="js/services/AuthService.js"></script>
    <script type="module" src="js/models/FreightModel.js"></script>
    <script type="module" src="js/views/FreightView.js"></script>
    <script type="module" src="js/controllers/FreightController.js"></script>

    <script>
        // Animação de entrada
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.querySelector('.main-layout').classList.remove('opacity-0');
                document.querySelector('.main-layout').classList.add('animate-enter');
            }, 100);
        });
    </script>
</body>

</html>